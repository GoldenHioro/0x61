// @ts-nocheck

/** MENSAGENS ‚Äî vers√£o final alinhada ao InformeCliente **/

// ======================================================
// SAUDA√á√ïES
// ======================================================

const SAUDACOES = [
  "Ol√°, {nome}!",
  "Oi, {nome}!",
  "Ol√°, {nome}! Tudo bem?",
  "Oi, {nome}! Como vai?",
  "Ol√°, {nome}! Espero que esteja bem.",
  "Ol√°, {nome}. Tudo certo por a√≠?",
  "Ol√°, {nome}. Como voc√™ est√°?",
  "Oi, {nome}! Tudo em ordem?",
  "{nome}, tudo bem?",
  "{nome}, como vai?",
  "{nome}, espero que esteja bem.",
  "{nome}, tudo certo por a√≠?",
  "{nome}, como est√° hoje?",
  "{nome}, espero que esteja tudo bem.",
  "Como vai, {nome}?",
  "Como voc√™ est√°, {nome}?",
  "Como est√£o as coisas, {nome}?",
  "Como tem passado, {nome}?",
  "Como est√° tudo por a√≠, {nome}?",
  "Como vai por a√≠, {nome}?",
  "Est√° tudo bem por a√≠, {nome}?",
  "Tudo bem com voc√™, {nome}?",
  "Espero que esteja tudo bem, {nome}.",
  "Espero que esteja tudo certo, {nome}.",
  "Espero que esteja tendo um bom dia, {nome}.",
  "Oi, {nome}! Como voc√™ tem passado?",
  "Ol√°, {nome}! Como est√£o as coisas por a√≠?",
  "{nome}, tudo tranquilo?",
  "{nome}, espero que seu dia esteja sendo bom!",
  "{nome}, espero que esteja tudo caminhando bem!",
  "Ol√°, {nome}! Tudo tranquilo por a√≠?",
  "Oi, {nome}. Espero que esteja tudo indo bem.",
  "Ol√°, {nome}! Tudo certo?",
  "Oi, {nome}. Espero que esteja tudo em paz.",
  "Como voc√™ tem estado, {nome}?",
  "Tudo certo por a√≠, {nome}?",
  "{nome}, tudo ok?",
  "Ol√°, {nome}! Tudo tranquilo por a√≠?",
  "Oi, {nome}. Como est√° o seu dia?",
  "{nome}, tudo em ordem?",
  "Espero que esteja bem, {nome}!",
  "Como est√° o dia, {nome}?",
  "{nome}, que o dia esteja sendo tranquilo!",
  "{nome}! Tudo indo bem por a√≠?",
  "Ol√°, {nome}. Desejo que esteja tudo bem.",
  "Como v√£o as coisas por a√≠, {nome}?",
  "Tudo certo com voc√™, {nome}? Tor√ßo que sim!",
  "Como seguem as coisas por a√≠, {nome}? Espero que tudo certo!"
];


// ======================================================
// INTRODU√á√ïES
// (100% v√°lidas, j√° com {processo} e {parteContraria})
// ======================================================

const INTRODUCOES = [
  "S√≥ informando sobre o processo contra {parteContraria}:",
  "Em rela√ß√£o ao processo {processo} contra {parteContraria}, saiu algo novo!",
  "Te trago uma atualiza√ß√£o sobre o processo {processo} contra {parteContraria}:",
  "Seu processo {processo} contra {parteContraria} registrou uma movimenta√ß√£o recente:",
  "Temos uma atualiza√ß√£o sobre o processo {processo} contra {parteContraria}.",
  "H√° uma nova movimenta√ß√£o no processo {processo} contra {parteContraria}:",
  "Tem novidades no processo contra {parteContraria}, veja s√≥:",
  "Sobre o processo {processo} contra {parteContraria}, segue uma atualiza√ß√£o:",
  "Revisei o processo {processo} contra {parteContraria} e encontrei novidade!",
  "Verifiquei seu processo {processo} contra {parteContraria} e h√° uma novidade:",
  "Atualiza√ß√µes ocorreram no processo {processo} contra {parteContraria}. No caso:",
  "Envio esta mensagem para atualizar sobre seu processo {processo} contra {parteContraria}:",
  "Sobre o processo {processo} contra {parteContraria}, trago o seguinte:",
  "Acompanhando o processo {processo} contra {parteContraria}, vi que temos atualiza√ß√£o:",
  "No processo {processo} contra {parteContraria}, temos o seguinte:",
  "O processo {processo} contra {parteContraria} teve a seguinte movimenta√ß√£o:",
  "Temos novidades sobre o processo {processo} contra {parteContraria}!",
  "Temos uma atualiza√ß√£o importante sobre o processo {processo} contra {parteContraria}.",
  "Veja s√≥ o que houve no processo contra {parteContraria}:",
  "Sobre o processo {processo} contra {parteContraria}, temos uma nova informa√ß√£o:",
  "Para manter voc√™ atualizado, segue o status do processo {processo} contra {parteContraria}:",
  "Cliente meu n√£o fica desinformado, ent√£o trago informa√ß√µes sobre o processo contra {parteContraria}:",
  "Como de costume, vim te manter a par do processo contra {parteContraria}!",
  "Trago informa√ß√µes recentes sobre o processo {processo} contra {parteContraria}:"
];

const INTERPRETACOES_SEM_MOV = [
  "N√£o houve atualiza√ß√£o recente no andamento do processo {proc} contra {parteContraria}.",
  "Por enquanto, o processo {proc} contra {parteContraria} segue sem novas movimenta√ß√µes.",
  "Nenhuma novidade foi registrada no processo {proc} contra {parteContraria} at√© o momento.",
  "O processo {proc} contra {parteContraria} n√£o recebeu novas movimenta√ß√µes desde a √∫ltima verifica√ß√£o.",
  "No momento, o processo {proc} contra {parteContraria} permanece sem altera√ß√µes.",
  "Ainda n√£o houve movimenta√ß√£o recente no processo {proc} contra {parteContraria}.",
  "O sistema n√£o registrou avan√ßos no processo {proc} contra {parteContraria} desde a √∫ltima consulta.",
  "At√© agora, o processo {proc} contra {parteContraria} segue est√°vel, sem novidades.",
  "Verifiquei novamente e o processo {proc} contra {parteContraria} continua sem movimenta√ß√£o.",
  "Por ora, n√£o h√° novidades no processo {proc} contra {parteContraria}."
];


// ======================================================
// ENCERRAMENTOS
// ======================================================

const ENCERRAMENTOS = [
  "Qualquer d√∫vida, me avise. Estou √† disposi√ß√£o!",
  "Se quiser entender mais sobre algo que mencionei, pode chamar.",
  "Ficarei atento a qualquer novidade e te aviso.",
  "Continuarei acompanhando tudo de perto e para te atualizar sobre os pr√≥ximos passos.",
  "Se precisar de algum esclarecimento a mais, conte comigo!",
  "No mais, √© s√≥ isso pra esse breve informe. Qualquer coisa, estamos a√≠!",
  "Seguimos por aqui. Qualquer coisa, pode contar comigo.",
  "Vamos seguindo! Qualquer coisa, √© s√≥ chamar, t√° certo?",
  "Finalizando a atualiza√ß√£o. Obrigado pela confian√ßa no acompanhamento.",
  "√â isso por ora. Se surgir qualquer d√∫vida, estou por aqui pra ajudar.",
  "Encerro aqui o informe e sigo atento para te deixar ciente das pr√≥ximas etapas.",
  "Por enquanto √© s√≥! Conte comigo se precisar de algo.",
  "Por enquanto √© isso! Conte comigo se precisar de alguma coisa. Abra√ßos!",
  "Assim concluo essa atualiza√ß√£o! Surgindo algo mais, eu volto para informar!.",
  "Assim termino essa breve atualiza√ß√£o! Se ocorrer algo, eu volto a entrar em contato. At√© mais!.",
  "Termino aqui esse update. Como de costume, saindo algo novo, eu volto aqui para te dizer, ok?.",
  "Finalizo por aqui. Se bater qualquer d√∫vida, me chama.",
  "Finalizo aqui! Qualquer d√∫vida, me chame!",
  "√â isso por agora. Agrade√ßo a confian√ßa e vamos em frente!",
  "Fechando o informe. Mantenho o acompanhamento conforme alinhamos.",
  "Por ora, tudo certo. Estou √† disposi√ß√£o se voc√™ precisar.",
  "√â s√≥ isso por enquanto. Seguimos em contato se necess√°rio.",
  "Encerrando a atualiza√ß√£o. Conte sempre comigo.",
  "No mais, √© isso! Tenha um bom dia!",
  "Por enquanto √© s√≥, sigo √† disposi√ß√£o!",
  "Por ora, √© isso. Conte comigo!",
  "√â s√≥ por agora. At√© mais!",
  "Encerramos por aqui, seguimos juntos!",
  "Assim finalizo a atualiza√ß√£o. At√© logo!",
  "No mais, √© isso. Estou por aqui se precisar!",
  "Fecho por aqui. Fique bem!",
  "√â isso por agora. Seguimos √† disposi√ß√£o!",
  "Assim concluo. Um abra√ßo!",
  "Por ora, √© s√≥. At√© mais!"
];



// ======================================================
// UTILIT√ÅRIOS
// ======================================================

function random(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

function extrairPrimeiroNome(nomeRaw) {
  if (!nomeRaw) return "";
  const partes = String(nomeRaw).trim().split(/\s+/);
  const primeiro = partes[0].toLowerCase();
  return primeiro.charAt(0).toUpperCase() + primeiro.slice(1);
}


// ======================================================
// BUSCAR PARTE CONTR√ÅRIA NA PLANILHA
// ======================================================

function obterParteContraria(numeroProcesso) {
  const ss = SpreadsheetApp.getActive();
  const aba = ss.getSheetByName("InformeCliente-APS");
  if (!aba) return { polo: "", parteContraria: "" };

  const dados = aba.getDataRange().getValues();
  const header = dados[0];

  const idxProc  = header.indexOf("N√∫meroProcesso");
  const idxPolo  = header.indexOf("PoloDoCliente");
  const idxParte = header.indexOf("NomeParteContraria");

  for (let i = 1; i < dados.length; i++) {
    if (String(dados[i][idxProc]).trim() === String(numeroProcesso).trim()) {
      return {
        polo: dados[i][idxPolo] || "",
        parteContraria: dados[i][idxParte] || ""
      };
    }
  }

  return { polo: "", parteContraria: "" };
}


// ======================================================
// MENSAGEM FINAL
// ======================================================

function gerarMensagemFinal(pje, interpretacao) {
  const primeiroNome = extrairPrimeiroNome(pje.nome);

  const processoCurto = String(pje.numero).substring(0, 10);

  const info = obterParteContraria(pje.numero);
  const parteContraria = info.parteContraria || "a outra parte";

  const saud = random(SAUDACOES).replace("{nome}", primeiroNome);
  const fim = random(ENCERRAMENTOS);

  const interpretacaoTrim = interpretacao.trim().toLowerCase();

  // Detecta aus√™ncia de movimenta√ß√£o
  const isSemMov =
    interpretacaoTrim.includes("n√£o houve atualiza√ß√£o") ||
    interpretacaoTrim.includes("n√£o h√° movimenta√ß√£o") ||
    interpretacaoTrim.includes("nenhuma movimenta√ß√£o") ||
    interpretacaoTrim.includes("n√£o teve movimenta√ß√£o") ||
    interpretacaoTrim.includes("sem movimenta√ß√£o");

  // üî• NOVO MODO TOTALMENTE ALEAT√ìRIO PARA "SEM MOVIMENTO"
  if (isSemMov) {
    const fraseSemMov = random(INTERPRETACOES_SEM_MOV)
      .replace("{proc}", processoCurto)
      .replace("{parte}", parteContraria);

    return `${saud} ${fraseSemMov} ${fim}`;
  }

  // üî• MODO NORMAL (MOVIMENTA√á√ÉO)
  const intro = random(INTRODUCOES)
    .replace("{processo}", processoCurto)
    .replace("{parteContraria}", parteContraria);

  return `${saud} ${intro} ${interpretacao} ${fim}`;
}


// ======================================================
// WHATSAPP
// ======================================================

function criarLinkWhats(telefone, mensagem) {
  if (!telefone) return "";

  let tel = String(telefone).replace(/\D/g, "");
  if (!tel.startsWith("55")) tel = "55" + tel;

  return `https://wa.me/${tel}?text=${encodeURIComponent(mensagem)}`;
}
